<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Estadístico UTAUT (JS Puro)</title>
    
    <!-- Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="text-slate-800">

    <div class="min-h-screen p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Análisis Estadístico UTAUT</h1>
            <p class="text-slate-500">Versión JavaScript Puro (Sin Instalación)</p>
        </header>

        <!-- SECCIÓN 1: CARGA DE ARCHIVO -->
        <div id="upload-section" class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-dashed border-slate-300 text-center transition-all duration-300">
            <div class="mb-4 flex justify-center text-blue-500">
                <i data-lucide="upload" width="48" height="48"></i>
            </div>
            <h2 class="text-xl font-semibold mb-2">Sube tu archivo de datos</h2>
            <p class="text-sm text-gray-500 mb-6">Soporta formato .CSV (EF01-04, EE01-04, CF01-04, IS01-03).</p>
            
            <input type="file" id="fileInput" accept=".csv" class="block w-full text-sm text-slate-500
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-50 file:text-blue-700
              hover:file:bg-blue-100 cursor-pointer"
            />
            <div id="errorMessage" class="hidden mt-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm text-left flex items-center gap-2">
                <i data-lucide="alert-circle" width="16"></i> <span id="errorText"></span>
            </div>
        </div>

        <!-- SECCIÓN 2: DASHBOARD (Oculto al inicio) -->
        <div id="dashboard-section" class="hidden space-y-8 max-w-7xl mx-auto mt-8">
            
            <!-- Barra de Estado -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex flex-wrap justify-between items-center">
                <div class="flex items-center gap-2 text-green-600">
                    <i data-lucide="check-circle" width="20"></i>
                    <span class="font-semibold">Datos procesados correctamente</span>
                </div>
                <div class="flex gap-4 text-sm text-slate-600">
                    <span>Registros: <strong id="totalRecords">0</strong></span>
                    <span>Alfa Total: <strong id="totalAlpha">0.000</strong></span>
                </div>
                <button onclick="resetApp()" class="px-4 py-1 text-sm bg-slate-100 hover:bg-slate-200 rounded transition">
                    Cargar nuevo archivo
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- 1. Tabla Descriptiva -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="file-text" class="text-blue-600"></i>
                        <h2 class="text-lg font-bold text-slate-800">1. Estadísticos Descriptivos</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="bg-slate-50 text-slate-800 font-semibold border-b">
                                <tr>
                                    <th class="px-4 py-2">Constructo</th>
                                    <th class="px-4 py-2">Media</th>
                                    <th class="px-4 py-2">Mediana</th>
                                    <th class="px-4 py-2">Min</th>
                                    <th class="px-4 py-2">Max</th>
                                    <th class="px-4 py-2">Q1</th>
                                    <th class="px-4 py-2">Q3</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody" class="divide-y">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-900 mb-2">Fiabilidad (Alfa de Cronbach)</h3>
                        <div id="alphaContainer" class="grid grid-cols-4 gap-4 text-center">
                            <!-- Alfas generados por JS -->
                        </div>
                    </div>
                </div>

                <!-- 2. Boxplots -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="bar-chart-2" class="text-blue-600"></i>
                        <h2 class="text-lg font-bold text-slate-800">2. Diagrama de Cajas (Boxplot)</h2>
                    </div>
                    <p class="text-xs text-slate-500 mb-6">Punto rojo = Media. Línea gruesa = Mediana. Caja azul = Rango Intercuartil (Q1-Q3).</p>
                    <div id="boxplotContainer" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <!-- SVGs generados por JS -->
                    </div>
                </div>

                <!-- 3. Histograma Global -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="activity" class="text-blue-600"></i>
                        <h2 class="text-lg font-bold text-slate-800">3. Pruebas de Normalidad Global (Campana de Gauss)</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="globalHistogramChart"></canvas>
                    </div>
                </div>

                <!-- 4. Pruebas de Normalidad -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="activity" class="text-blue-600"></i>
                        <h2 class="text-lg font-bold text-slate-800">4. Pruebas de Normalidad (Campana de Gauss)</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-2 border rounded">
                            <h4 class="text-center text-sm font-bold mb-2">Exp. Funcionamiento</h4>
                            <div style="height: 200px;"><canvas id="chartEF"></canvas></div>
                        </div>
                        <div class="bg-white p-2 border rounded">
                            <h4 class="text-center text-sm font-bold mb-2">Exp. Esfuerzo</h4>
                            <div style="height: 200px;"><canvas id="chartEE"></canvas></div>
                        </div>
                        <div class="bg-white p-2 border rounded">
                            <h4 class="text-center text-sm font-bold mb-2">Cond. Facilitadoras</h4>
                            <div style="height: 200px;"><canvas id="chartCF"></canvas></div>
                        </div>
                        <div class="bg-white p-2 border rounded">
                            <h4 class="text-center text-sm font-bold mb-2">Inf. Social</h4>
                            <div style="height: 200px;"><canvas id="chartIS"></canvas></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- LÓGICA JAVASCRIPT -->
    <script>
        // Inicializar Iconos
        lucide.createIcons();

        // Variables Globales
        let chartsInstance = []; // Para destruir gráficos viejos al recargar

        // --- FUNCIONES MATEMÁTICAS ---
        const mean = (arr) => {
            const valid = arr.filter(v => v !== null && !isNaN(v));
            if (!valid.length) return 0;
            return valid.reduce((a, b) => a + b, 0) / valid.length;
        };

        const stdDev = (arr) => {
            const valid = arr.filter(v => v !== null && !isNaN(v));
            if (valid.length <= 1) return 0;
            const m = mean(valid);
            const sumSq = valid.reduce((a, b) => a + Math.pow(b - m, 2), 0);
            return Math.sqrt(sumSq / (valid.length - 1));
        };

        const getStats = (arr) => {
            const valid = arr.filter(v => v !== null && !isNaN(v)).sort((a, b) => a - b);
            if (!valid.length) return null;
            
            const q1Pos = (valid.length - 1) * 0.25;
            const q3Pos = (valid.length - 1) * 0.75;
            
            const getVal = (pos) => {
                const base = Math.floor(pos);
                const rest = pos - base;
                if (valid[base + 1] !== undefined) {
                    return valid[base] + rest * (valid[base + 1] - valid[base]);
                }
                return valid[base];
            };

            return {
                mean: mean(valid),
                median: getVal((valid.length - 1) * 0.5),
                min: valid[0],
                max: valid[valid.length - 1],
                q1: getVal(q1Pos),
                q3: getVal(q3Pos),
                n: valid.length
            };
        };

        const calculateCronbach = (data, columns) => {
            if (!data || !data.length) return 0;
            let sumItemVariances = 0;
            columns.forEach(col => {
                const values = data.map(row => parseFloat(row[col]));
                const variance = Math.pow(stdDev(values), 2);
                sumItemVariances += variance;
            });
            const totalScores = data.map(row => {
                return columns.reduce((sum, col) => sum + (parseFloat(row[col]) || 0), 0);
            });
            const totalVariance = Math.pow(stdDev(totalScores), 2);
            const k = columns.length;
            if (totalVariance === 0) return 0;
            return (k / (k - 1)) * (1 - (sumItemVariances / totalVariance));
        };

        const normalPDF = (x, mu, sigma) => {
            if (sigma === 0) return 0;
            const num = Math.exp(-Math.pow(x - mu, 2) / (2 * Math.pow(sigma, 2)));
            const denom = sigma * Math.sqrt(2 * Math.PI);
            return num / denom;
        };

        // --- MANEJO DE ARCHIVOS Y DATOS ---
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', handleFileUpload);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const text = evt.target.result;
                    const lines = text.split('\n').filter(l => l.trim() !== '');
                    if (lines.length < 2) throw new Error("El archivo parece estar vacío o mal formado");

                    // Detectar delimitador
                    const firstLine = lines[0];
                    const delimiter = firstLine.includes(';') ? ';' : ',';
                    
                    const headers = firstLine.split(delimiter).map(h => h.trim().replace(/"/g, ''));
                    
                    const rawData = lines.slice(1).map(line => {
                        const values = line.split(delimiter);
                        const obj = {};
                        headers.forEach((h, i) => {
                            const val = values[i] ? values[i].replace(/"/g, '').replace(',', '.') : null;
                            obj[h] = val ? parseFloat(val) : null;
                        });
                        return obj;
                    });

                    processData(rawData, headers);
                } catch (err) {
                    showError(err.message || "Error al leer el archivo CSV.");
                }
            };
            reader.readAsText(file);
        }

        function processData(rawData, headers) {
            const map = {
                EF: ['EF01', 'EF02', 'EF03', 'EF04'],
                EE: ['EE01', 'EE02', 'EE03', 'EE04'],
                CF: ['CF01', 'CF02', 'CF03', 'CF04'],
                IS: ['IS01', 'IS02', 'IS03']
            };

            // Validar
            const missing = [];
            Object.values(map).flat().forEach(col => {
                if (!headers.includes(col)) missing.push(col);
            });
            if (missing.length > 0) {
                showError(`Faltan columnas: ${missing.join(', ')}`);
                return;
            }

            // Calcular Constructos
            const processed = rawData.map(row => ({
                EF: mean(map.EF.map(c => row[c])),
                EE: mean(map.EE.map(c => row[c])),
                CF: mean(map.CF.map(c => row[c])),
                IS: mean(map.IS.map(c => row[c]))
            }));

            const stats = {
                EF: getStats(processed.map(r => r.EF)),
                EE: getStats(processed.map(r => r.EE)),
                CF: getStats(processed.map(r => r.CF)),
                IS: getStats(processed.map(r => r.IS))
            };

            const alphas = {
                EF: calculateCronbach(rawData, map.EF),
                EE: calculateCronbach(rawData, map.EE),
                CF: calculateCronbach(rawData, map.CF),
                IS: calculateCronbach(rawData, map.IS),
                Total: calculateCronbach(rawData, [...map.EF, ...map.EE, ...map.CF, ...map.IS])
            };

            // Calcular límites globales para gráficos
            const allMins = [stats.EF.min, stats.EE.min, stats.CF.min, stats.IS.min];
            const allMaxs = [stats.EF.max, stats.EE.max, stats.CF.max, stats.IS.max];
            const globalLimits = {
                min: Math.floor(Math.min(...allMins)),
                max: Math.ceil(Math.max(...allMaxs))
            };

            renderUI(stats, alphas, processed, globalLimits);
        }

        // --- RENDERIZADO UI ---
        function renderUI(stats, alphas, constructs, limits) {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            // Info Header
            document.getElementById('totalRecords').innerText = stats.EF.n;
            document.getElementById('totalAlpha').innerText = alphas.Total.toFixed(3);

            // 1. Tabla
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            Object.entries(stats).forEach(([key, val]) => {
                const row = `<tr class="hover:bg-slate-50">
                    <td class="px-4 py-2 font-medium">${key}</td>
                    <td class="px-4 py-2">${val.mean.toFixed(2)}</td>
                    <td class="px-4 py-2">${val.median.toFixed(2)}</td>
                    <td class="px-4 py-2">${val.min}</td>
                    <td class="px-4 py-2">${val.max}</td>
                    <td class="px-4 py-2">${val.q1.toFixed(2)}</td>
                    <td class="px-4 py-2">${val.q3.toFixed(2)}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // Alfas
            const alphaContainer = document.getElementById('alphaContainer');
            alphaContainer.innerHTML = '';
            Object.entries(alphas).forEach(([k, v]) => {
                if(k === 'Total') return;
                alphaContainer.innerHTML += `
                    <div>
                        <div class="text-xs uppercase text-blue-500">${k}</div>
                        <div class="font-bold text-blue-800">${v.toFixed(3)}</div>
                    </div>`;
            });

            // 2. Boxplots SVG
            const boxContainer = document.getElementById('boxplotContainer');
            boxContainer.innerHTML = '';
            const labels = { EF: "Exp. Func", EE: "Exp. Esf", CF: "Cond. Fac", IS: "Inf. Soc" };
            Object.entries(stats).forEach(([key, val]) => {
                boxContainer.innerHTML += createBoxPlotSVG(val, labels[key], limits.min, limits.max);
            });

            // 3. Gráficos (Chart.js)
            // Limpiar anteriores
            chartsInstance.forEach(chart => chart.destroy());
            chartsInstance = [];

            // Datos Globales
            const allValues = constructs.flatMap(c => [c.EF, c.EE, c.CF, c.IS]).filter(v => v !== null);
            createHistogram(allValues, 'globalHistogramChart', 'Histograma Global', limits);

            // Datos Individuales
            createHistogram(constructs.map(c => c.EF), 'chartEF', 'EF', limits);
            createHistogram(constructs.map(c => c.EE), 'chartEE', 'EE', limits);
            createHistogram(constructs.map(c => c.CF), 'chartCF', 'CF', limits);
            createHistogram(constructs.map(c => c.IS), 'chartIS', 'IS', limits);
        }

        function createBoxPlotSVG(data, label, globalMin, globalMax) {
            const height = 300;
            const width = 150;
            const padding = 30;
            const plotHeight = height - padding * 2;
            
            // Escala
            const yScale = (val) => height - padding - ((val - globalMin) / (globalMax - globalMin)) * plotHeight;
            
            // Ticks
            let ticksSVG = '';
            for(let i = globalMin; i <= globalMax; i++) {
                const y = yScale(i);
                ticksSVG += `<g><line x1="35" x2="40" y1="${y}" y2="${y}" stroke="#ccc" /><text x="30" y="${y+4}" text-anchor="end" font-size="10" fill="#666">${i}</text></g>`;
            }

            const q1Y = yScale(data.q1);
            const q3Y = yScale(data.q3);
            const medY = yScale(data.median);
            const minY = yScale(data.min);
            const maxY = yScale(data.max);
            const meanY = yScale(data.mean);
            const rectHeight = Math.max(Math.abs(q1Y - q3Y), 2);

            return `
            <div class="flex flex-col items-center">
                <svg width="${width}" height="${height}" class="bg-white border rounded shadow-sm">
                    <line x1="40" x2="40" y1="${padding}" y2="${height-padding}" stroke="#ccc" />
                    ${ticksSVG}
                    <!-- Boxplot lines -->
                    <line x1="${width/2}" x2="${width/2}" y1="${minY}" y2="${maxY}" stroke="#666" stroke-width="2" stroke-dasharray="4 4" />
                    <rect x="${width/2 - 20}" y="${q3Y}" width="40" height="${rectHeight}" fill="#bfdbfe" stroke="#2563eb" stroke-width="2" />
                    <line x1="${width/2 - 20}" x2="${width/2 + 20}" y1="${medY}" y2="${medY}" stroke="#1e40af" stroke-width="3" />
                    <line x1="${width/2 - 10}" x2="${width/2 + 10}" y1="${minY}" y2="${minY}" stroke="#666" stroke-width="2" />
                    <line x1="${width/2 - 10}" x2="${width/2 + 10}" y1="${maxY}" y2="${maxY}" stroke="#666" stroke-width="2" />
                    <circle cx="${width/2}" cy="${meanY}" r="4" fill="red" stroke="white" />
                </svg>
                <span class="mt-2 font-bold text-gray-700 text-sm">${label}</span>
                <span class="text-xs text-gray-500">Media: ${data.mean.toFixed(2)}</span>
            </div>`;
        }

        function createHistogram(dataArr, canvasId, label, limits) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const m = mean(dataArr);
            const s = stdDev(dataArr);
            const bins = 12;
            const min = limits.min;
            const max = limits.max;
            const step = (max - min) / bins;

            const labels = [];
            const counts = [];
            const normalData = [];

            for(let i=0; i<bins; i++) {
                const rangeStart = min + i * step;
                const rangeEnd = rangeStart + step;
                const mid = (rangeStart + rangeEnd) / 2;
                
                const count = dataArr.filter(v => v >= rangeStart && v < rangeEnd).length;
                // Curva normal escalada
                const normalVal = normalPDF(mid, m, s) * dataArr.length * step;
                
                labels.push(mid.toFixed(1));
                counts.push(count);
                normalData.push(normalVal);
            }

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Curva Normal',
                            data: normalData,
                            type: 'line',
                            borderColor: '#dc2626',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Frecuencia',
                            data: counts,
                            backgroundColor: '#93c5fd',
                            barPercentage: 1.0,
                            categoryPercentage: 1.0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            chartsInstance.push(chart);
        }

        function showError(msg) {
            const errDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').innerText = msg;
            errDiv.classList.remove('hidden');
        }

        function resetApp() {
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            chartsInstance.forEach(c => c.destroy());
            chartsInstance = [];
        }
    </script>
</body>
</html>